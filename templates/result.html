{% extends "layout.html" %}
{% block title %} Map {% endblock %}
{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
<link rel="stylesheet" href="static/css/style.css">
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
{% endblock %}
{% block body %}
<!--
<form action="/result" method="get" id="form">
    <label for="url">Tweet URL</label>
    <input type="text" name="name">
    <button type="submit">送信</button>
</form>
-->
<div id="mapid"></div>
<script type="text/javascript">
 let quake_dics = JSON.parse('{{ quake_dics | tojson }}');

 let intensity_colorcode = {
        1: '#0c0e0e',
        2: '#0f3b3d',
        3: '#00269a',
        4: '#5d4d0d',
        A: '#c2b326',
        B: '#b47518',
        C: '#9f1b03',
        D: '#770012',
        7: '#86004b'
    };

let tweet_intensities = [];

for(let j in quake_dics){
  intensities = quake_dics[j]["intensities"];
  let circles = [];
  for (let i in intensities){
      let lat = intensities[i]["latitude"];
      let lon = intensities[i]["longitude"];
      let latlng = L.latLng(lat, lon);
      let observ = intensities[i]["observ_point_num"];
      let intensity_num = intensities[i]["intensity"];


      let circle = L.circle(latlng, {
          color: intensity_colorcode[intensity_num],
          fillColor: intensity_colorcode[intensity_num],
          fillOpacity:0.3,
          radius: 1000
      });
    circles.push(circle);
  }
  tweet_intensities.push(L.layerGroup(circles));
}
let tweet_urls = JSON.parse('{{ tweet_urls | tojson }}');

//重複観測点を追加
let overlap_observ_points = JSON.parse('{{ overlap_observ_points | tojson }}');

let overlap_circles = [];
for(let i in overlap_observ_points){
  let lat = overlap_observ_points[i]["latitude"];
  let lon = overlap_observ_points[i]["longitude"];
  let latlng = L.latLng(lat,lon);

  let circle = L.circle(latlng, {
    color: '#ff0000',
    fillColor: '#ff0000',
    fillOpacity: 0.3,
    radius:1000
  });

  overlap_circles.push(circle);
}

overlap_layergroup = L.layerGroup(overlap_circles);

//チェックボックスの項目
let overlayLayerControls = {};
for(let i in tweet_urls){
  overlayLayerControls[tweet_urls[i]] = tweet_intensities[i];
}
overlayLayerControls["重複している観測点"] = overlap_layergroup;

//マップ作製
var tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© <a href="http://osm.org/copyright">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
});
var map = L.map('mapid', {
  center: [36, 140],
  zoom: 5,
  layers: [tileLayer].concat(tweet_intensities),
});
map.zoomControl.setPosition("bottomright");

//オーバーレイレイヤーを追加
L.control.layers(null, overlayLayerControls,{
  collapsed: false,
}).addTo(map);

//mapの上におくformを定義
L.Control.form = L.Control.extend({
  onAdd: function(map){
    let text = L.DomUtil.create('div');
    text.id= "l-control-form";
    text.innerHTML = `<form action="/result" method="get" id="form">
    <label for="url">Tweet URL</label>
    <input type="text" name="name">
    <button type="submit">追加</button>
</form>`;
    return text;
  },

  onRemove: function(map){

  }
});
L.control.form = function(opts){
  return new L.Control.form(opts);
}
L.control.form({position: 'topleft'}).addTo(map);

//mapの上に置くlabelを定義
L.Control.label = L.Control.extend({
  onAdd: function(map){
    let text = L.DomUtil.create('div');
    text.id = "source";
    text.innerHTML = '<p>気象庁「震度データ 2010～2018」（https://www.data.jma.go.jp/svd/eqev/data/bulletin/shindo.html）を加工して作成</p>';
    return text;
  },
  onRemove: function(map){}
});
L.control.label = function(opts){
  return new L.Control.label(opts);
}
L.control.label({position: 'bottomleft'}).addTo(map);

//type=hiddenでツイートリスを置いておく
for(let i in tweet_urls){
  document.getElementById("form").insertAdjacentHTML('afterbegin', '<input type="hidden" name="name" value="' + tweet_urls[i] + '">');
  //document.getElementById("tweeturlpv").insertAdjacentHTML('afterbegin', "<p>" + tweet_urls[i] + "<\/p>");
}

//checkboxの横にformを置いてボタンとhiddeninputを追加する
for(let i = 0; i < tweet_urls.length; i++){
  let overlay_span_element = document.querySelector('.leaflet-control-layers-overlays label:nth-child(' + (i+1) + ') div span');
  overlay_span_element.insertAdjacentHTML('afterend', '<form action="/result" method="get" style="display: inline" id="remove' + i + '"><button type="submit">削除</button></form>');

  let form = document.querySelector('#remove' + i);
  for(let j = 0; j < tweet_urls.length; j++){
    if(i != j){
      form.insertAdjacentHTML('afterbegin', '<input type="hidden" name="name" value="' + tweet_urls[j] + '">');
    }
  }
}

</script>

{% endblock %}
